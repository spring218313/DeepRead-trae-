混合策略（推荐）
- 架构原则
  - 本地优先：所有核心读写走设备 SQLite；确保离线可用与最低延迟。
  - 可选云：在设置中提供“云备份与同步”开关；默认关闭，用户主动开启。
  - 模块化：通过 `storageAdapter` 抽象本地与云端，实现可插拔与最小侵入。
- 数据流与同步模型
  - 变更记录：为 `highlights / annotations / user_notes / progress` 记录 `updated_at / version` 字段，用于增量同步。
  - 同步方向：本地→云端备份；云端→本地恢复/合并。默认采用 LWW（Last-Write-Wins）按 `updated_at` 解决冲突。
  - 粒度选择：以“高亮/批注”为基本实体同步，避免整库覆盖；大文本内容 `book_content` 可选择只备份元数据或云端拉取。
  - 批量策略：上线后台任务（App 前台时定时或手动触发），分页上传/下载，防止阻塞 UI。
- 设置与用户控制
  - 开关项：云备份与同步（含说明与隐私提示）。
  - 备份频率：手动、每天一次、仅 Wi Fi。
  - 导入/导出：一键导出 JSON 或 `.db`；选择文件导入与合并。
  - 账号关联（可选）：开启云端后可登录账户用于多设备同步；未登录保持本地模式。
- 隐私与安全
  - 本地数据：可选加密（AES GCM）保护敏感笔记；密钥存于设备安全存储。
  - 云端数据：启用 Supabase RLS，数据仅限本人访问；密钥仅服务端可见（Edge Functions 调用外部 API）。
  - 可撤销：用户可关闭同步并清理云端副本（提供“清除云备份”操作）。
- 失败场景与降级
  - 网络不可用：停留本地模式，记录待同步队列；显示离线状态。
  - 冲突或合并失败：提示保留两份版本，允许手动选择；日志上报便于排查。
  - 云端异常：自动退回本地备份；不影响阅读与编辑。
- 技术实现
  - 本地层：Capacitor + `@capacitor-community/sqlite`，统一 CRUD；`@capacitor/filesystem` 用于导入/导出。
  - 云端层：`@supabase/supabase-js` + RLS；同步器模块读取本地变更并增量上行，下行按版本合并。
  - 边缘函数：封装敏感操作与复杂合并，后续支持分享与协作。
  - 适配层：`storageAdapter` 暴露 `get/put/list` 与同步钩子；Reader 与 Stories 仅依赖该接口。
- 开发计划（增量）
  - 阶段 1：完成本地 SQLite 与导入/导出；抽象 `storageAdapter` 并接入 Reader/Stories。
  - 阶段 2：设置页加入“云备份与同步（Beta）”开关；实现单向备份（本地→云）。
  - 阶段 3：实现下行恢复与合并（云→本地），LWW 策略与冲突提示；加入备份频率与仅 Wi Fi。
  - 阶段 4：优化同步性能与错误处理；增加边缘函数与分享（可选）。
- 指标与验收
  - 离线可读写、重启后数据不丢失。
  - 打开同步后，另一设备的数据在 60 秒内可恢复。
  - 冲突场景可提示并人工选择；关闭同步后隐私清理生效。
