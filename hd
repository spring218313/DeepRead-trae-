DeepRead 后端模块项目结构与开发计划

一、目标与对接范围
- 目标：在不改动现有前端的前提下，提供可选的云后端模块，实现数据持久化、备份/同步与搜索能力，面向 Android/iOS App。
- 前端对接点（只做兼容接口设计，不修改当前代码）：
  - 高亮/批注创建与更新：`components/Reader.tsx:339-358, 361-390, 392-404, 406-419`
  - 阅读进度：`components/Reader.tsx:409-411`
  - 用户笔记（Stories）：`App.tsx:134-166`（列表展示与导入导出）
- 策略：后端提供 REST/Edge API 与强类型契约，未来前端仅需替换 `storageAdapter` 的实现即可对接，不动 UI/交互。

二、API 合约（REST）
- 认证：Bearer JWT（Supabase Auth 或自建），所有 API 基于用户身份进行读写。
- 端点设计（简化）：
  - `POST /api/books` 创建书籍元数据
  - `GET /api/books` 列出书籍（分页）
  - `GET /api/books/:id/content` 拉取分段内容（含分页与段落索引）
  - `POST /api/books/:id/highlights` 批量新增或覆盖高亮
  - `GET /api/books/:id/highlights` 拉取高亮列表（分页/按段落过滤）
  - `PATCH /api/books/:id/highlights/:hid` 更新颜色/样式
  - `DELETE /api/books/:id/highlights/:hid` 删除
  - `POST /api/books/:id/annotations` 新增批注
  - `PATCH /api/books/:id/annotations/:aid` 更新批注文本/坐标
  - `DELETE /api/books/:id/annotations/:aid` 删除
  - `PUT /api/books/:id/progress` 写入阅读进度
  - `GET /api/user-notes` 列出用户笔记（Stories 源）
  - `POST /api/user-notes` 新增/更新用户笔记（由批注同步生成）
  - `POST /api/backup/export` 导出用户数据（JSON）
  - `POST /api/backup/import` 导入用户数据（JSON），提供冲突策略选项
- 请求/响应字段与 `types.ts` 映射：
  - `Highlight`：`id,text,paragraphIndex,startOffset,color,style,noteId`
  - `Annotation`：`id,highlightId,text,top,pointX,color`
  - `UserNote`：`id,bookId,quote,thought,date`
  - 统一附加：`updated_at, version` 字段用于增量同步与冲突处理

三、数据库与模型
- 选型：Supabase Postgres（RLS + FTS）或自建 Postgres（等价表结构）
- 表：
  - `users`（Auth 托管）
  - `books(id, title, author, total_params, meta, owner_id)`
  - `book_content(id, book_id, paragraph_index, text)`
  - `highlights(id, user_id, book_id, paragraph_index, start_offset, end_offset, color, style, note_id, updated_at, version)`
  - `annotations(id, user_id, highlight_id, text, top, point_x, color, updated_at, version)`
  - `user_notes(id, user_id, book_id, quote, thought, date, updated_at, version)`
  - `progress(id, user_id, book_id, percent, updated_at)`
- 索引：
  - `book_content(book_id, paragraph_index)`、`highlights(user_id, book_id, paragraph_index)`
  - FTS：`book_content(text)` 建 `tsvector`，支持书内搜索
- 安全：
  - RLS：用户仅访问 `user_id = auth.uid()` 的行；分享时扩策略或共享表

四、项目结构（后端）
- 方案 A：Supabase Edge Functions（Deno）+ Postgres（推荐最小化）
  - `functions/`
    - `books.ts`（书籍与内容）
    - `highlights.ts`（批量增删改查）
    - `annotations.ts`
    - `progress.ts`
    - `user_notes.ts`
    - `backup.ts`（导入导出）
    - `auth.ts`（中间件）
  - `lib/`
    - `db.ts`（数据库连接与查询封装）
    - `schemas.ts`（zod 验证）
    - `sync.ts`（版本与冲突策略：LWW）
  - `tests/`（单元与集成）

五、同步与冲突策略
- 模型：增量同步，客户端按实体携带 `updated_at, version`。
- 策略：默认 LWW（更新时间晚者胜）；同段落重叠合并逻辑与前端保持一致（参考 `components/Reader.tsx:262-279`）。
- 批量接口：支持部分成功与错误报告；分页与断点续传。

六、权限与隐私
- 认证：Supabase Auth（Email/OAuth）或自建 JWT；匿名模式仅允许本地使用，不访问云。
- 授权：RLS 与最小权限；备份导出仅限本人；提供“清除云备份”端点。
- 加密（可选）：对敏感笔记进行字段级加密。

七、部署与运维
- 环境变量：`SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `JWT_SECRET` 等。
- 部署：Supabase Functions 或 CF Workers/Vercel。启用日志采集与错误告警。
- 监控：请求量、错误率、同步延迟、备份体积。

八、开发计划
- [x] 第一阶段：核心后端 API 实现 (Highlights, Annotations, Progress, User Notes)
- [x] 第二阶段：数据库表结构与 FTS 搜索索引
- [x] 第三阶段：基础认证与限流逻辑
- [x] 第四阶段：备份/导入导出功能
- [ ] 第五阶段：前端 storageAdapter 对接云端 API (待切换)
- [ ] 第六阶段：多端同步冲突处理优化与上线验收

九、验收标准
- 契约一致：API 字段与 `types.ts` 完整映射。
- 正确性：高亮/批注/进度在后端可写可读，备份导入后数据一致。
- 性能：批量写入每秒 1000 条以内稳定；搜索响应 < 300ms（小数据集）。
- 安全：RLS 生效，未认证不可访问；导出仅限本人。

十、接入方式（保留前端不改动）
- 创建新的 `storageAdapter` 云实现（仅作为后续替换目标），接口签名与当前一致：
  - `loadHighlights/saveHighlightsBulk/updateHighlightColor/deleteHighlight`
  - `loadUserNotes/upsertUserNote/deleteUserNote`
  - `saveProgress/loadProgress`
- 切换点：在 `storageAdapter.ts` 中通过环境变量开关切换本地/云端模式。
